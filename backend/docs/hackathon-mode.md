# Архитектура и развертывание NER-сервиса (Hackathon-режим)

Этот документ описывает внутреннее устройство, технологии и процесс развертывания Docker-образа, создаваемого с помощью файла `docker-compose.hackathon.yml`.

## Обзор архитектуры

`docker-compose.hackathon.yml` предназначен для создания и запуска одного, изолированного и высокопроизводительного Docker-контейнера, в котором находится наш ML-сервис. Его главная задача — отвечать на API-запросы максимально быстро, как того требуют условия хакатона.

**Компоненты системы:**

- **Docker Compose (`docker-compose.hackathon.yml`)**: В данной конфигурации он собирает только один сервис — `ner_service`.
- **Веб-фреймворк (FastAPI)**: Внутри контейнера работает приложение на FastAPI. Это современный Python-фреймворк, который принимает HTTP-запросы на эндпоинт `/api/predict`, передает данные в модель и возвращает ответ в формате JSON.
- **ML-модель (spaCy)**: Ядро нашего сервиса — это модель, обученная с помощью библиотеки spaCy. Она отвечает за непосредственное извлечение именованных сущностей из текста.

## Как подключается и работает модель?

Многие задаются вопросом, как код внутри контейнера «видит» файлы модели. Процесс очень простой:

1. **Копирование в образ**: Во время сборки образа команда `COPY . .` в `Dockerfile` берет всё содержимое папки `ml` (включая подпапку `model` со всеми файлами) и копирует его внутрь Docker-образа в директорию `/app`.
2. **Загрузка в память**: Когда приложение FastAPI запускается, выполняется код из файла `ml/app/logic.py`. Строка `nlp = spacy.load("model")` говорит библиотеке spaCy: «Найди в текущей рабочей директории папку `model` и загрузи из нее все необходимые файлы в оперативную память».

Таким образом, модель становится неотъемлемой частью Docker-образа и всегда доступна для приложения.

## Что такое Gunicorn и зачем он нужен?

Gunicorn — это production-ready веб-сервер для Python. Он не используется при локальной разработке, но критически важен для «боевого» режима.

Именно Gunicorn запускает ваш сервис внутри контейнера. Это прописано в последней строке `Dockerfile`:

```bash
CMD ["gunicorn", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "app.main:app", "-b", "0.0.0.0:8000"]
```



### Сколько воркеров нужно для PROD-сервера?

Оптимальное количество воркеров напрямую зависит от количества ядер процессора (CPU) на вашем сервере.

**Формула для расчета:** (2 * количество ядер CPU) + 1

**Как это определить:**

1. Узнайте, сколько ядер у процессора на вашем production-сервере (например, 2, 4, 8).
2. Подставьте это число в формулу.

**Пример:**

Если на вашем сервере 2 ядра CPU, то оптимальное количество воркеров: (2 * 2) + 1 = 5.

Вам нужно будет изменить `ml/Dockerfile`, заменив `-w 4` на `-w 5`, и пересобрать образ перед развертыванием.

 

## Как запустить всё самостоятельно?

1. Установите Docker и Docker Compose на ваш компьютер или сервер.
2. Откройте терминал и перейдите в директорию `backend`, где лежит `docker-compose.hackathon.yml`.
3. Выполните команду:

```bash
docker-compose -f docker-compose.hackathon.yml up --build
```

Дождитесь, пока сервис запустится. Откройте новый терминал и протестируйте его с помощью `curl`:

```bash
curl -X POST "http://localhost:8000/api/predict" \
-H "Content-Type: application/json" \
-d '{"input": "сгущенное молоко"}'
```


