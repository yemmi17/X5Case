# Работа с Poetry в микросервисах

## 1. Что такое Poetry?

Poetry — это инструмент для управления зависимостями в Python-проектах. В вашем проекте он используется для того, чтобы у каждого микросервиса (api_gateway, search_service) был свой собственный, изолированный набор пакетов с их точными версиями. Это решает проблему конфликтов и гарантирует, что код будет работать одинаково везде.

## 2. Основной принцип работы

Все команды Poetry нужно выполнять из директории конкретного сервиса. Перед началом работы всегда переходите в нужную папку:

```bash
# Пример: работаем с API Gateway
cd backend/api_gateway

# Или с сервисом поиска
cd backend/search_service
```

## 3. Ключевые команды

### Установка зависимостей (первичная настройка)

После клонирования проекта или после обновления poetry.lock в Git, используйте эту команду для установки всех нужных пакетов.

```bash
poetry install --no-root
```

Флаг `--no-root` нужен, потому что наши сервисы — это приложения, а не библиотеки для установки.

### Активация виртуального окружения

Чтобы "войти" в изолированное окружение сервиса и работать в нём:

```bash
source $(poetry env info --path)/bin/activate
```

После активации в терминале появится префикс, например, `(api-gateway-py3.12)`.

Для выхода из окружения используйте команду `exit`.

### Добавление новой зависимости

```bash
# Пример для добавления пакета loguru
poetry add loguru
```

Эта команда автоматически добавит пакет в `pyproject.toml`, установит его и обновит `poetry.lock`.

### Удаление зависимости

```bash
poetry remove <имя_пакета>
```

### Запуск команд без активации окружения

Если вам нужно просто выполнить одну команду (например, запустить сервер), можно не активировать окружение, а использовать `poetry run`:

```bash
poetry run uvicorn app.main:app --reload --port 8000
```

## 4. Как найти путь к интерпретатору (для VS Code и других IDE)

Чтобы IDE "увидела" пакеты из виртуального окружения, ей нужно указать путь к его файлу Python.

1. Перейдите в папку нужного сервиса.
2. Выполните команду:

```bash
echo "$(poetry env info --path)/bin/python"
```

3. Скопируйте выведенный путь и вставьте его в настройках интерпретатора вашей IDE.

## 5. Структура проекта

```
backend/
├── api_gateway/
│   ├── app/
│   ├── pyproject.toml
│   ├── poetry.lock
│   └── Dockerfile
├── search_service/
│   ├── app/
│   ├── pyproject.toml
│   ├── poetry.lock
│   └── Dockerfile
└── docs/
    └── poetry-guide.md
```

Каждый сервис имеет свой собственный `pyproject.toml` и `poetry.lock`, что обеспечивает изоляцию зависимостей между сервисами.

## 6. Полезные команды для отладки

### Проверка текущего окружения

```bash
poetry env info
```

### Просмотр установленных пакетов

```bash
poetry show
```

### Проверка зависимостей

```bash
poetry check
```

### Обновление зависимостей

```bash
poetry update
```

## 7. Рекомендации

1. **Всегда используйте Poetry** для управления зависимостями в проекте
2. **Не редактируйте poetry.lock вручную** — этот файл генерируется автоматически
3. **Коммитьте poetry.lock** в Git для воспроизводимости сборки
4. **Используйте точные версии** в `pyproject.toml` для критичных зависимостей
5. **Регулярно обновляйте** зависимости для получения исправлений безопасности
